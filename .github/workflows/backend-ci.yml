name: Backend CI

# ============================================================
# íŠ¸ë¦¬ê±° ì„¤ì •: PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ + ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
# ============================================================
on:
  # PR ì´ë²¤íŠ¸ (ì½”ë“œ ê²€ì¦ìš©)
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev
      - main
    # ë°±ì—”ë“œ ê´€ë ¨ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'
      - '.github/workflows/backend-ci.yml'

  # Push ì´ë²¤íŠ¸ (CD íŠ¸ë¦¬ê±°ìš©)
  push:
    branches:
      - dev
      - main
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'
      - '.github/workflows/backend-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

# ============================================================
# ë™ì‹œì„± ì œì–´: ê°™ì€ PR ë˜ëŠ” ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì‹¤í–‰ ì‹œ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
# ============================================================
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ============================================================
# CI ì‘ì—… ì •ì˜
# ============================================================
jobs:
  backend-ci:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # ========================================================
    # MySQL ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ (í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤)
    # ========================================================
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s

    # ========================================================
    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (application-ci.ymlì—ì„œ ì‚¬ìš©)
    # ========================================================
    env:
      SPRING_PROFILES_ACTIVE: ci
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: root
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    # ========================================================
    # CI ë‹¨ê³„ (Steps)
    # ========================================================
    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------
      # 2. JDK ì„¤ì • ë° Gradle ìºì‹±
      # ------------------------------------------------------
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # ------------------------------------------------------
      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      # ------------------------------------------------------
      - name: ğŸ”§ Grant execute permission for gradlew
        run: chmod +x gradlew

      # ------------------------------------------------------
      # 4. ì •ì  ë¶„ì„ - Checkstyle
      # ------------------------------------------------------
      - name: ğŸ” Run Checkstyle
        id: checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: false

      # ------------------------------------------------------
      # 5. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      # ------------------------------------------------------
      - name: ğŸ—ï¸ Build with Gradle
        id: build
        run: ./gradlew clean build -x test

      # ------------------------------------------------------
      # 6. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
      # ------------------------------------------------------
      - name: ğŸ§ª Run tests with coverage
        id: test
        run: ./gradlew test jacocoTestReport --parallel

      # ------------------------------------------------------
      # 7. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ“Š Verify test coverage
        id: coverage
        run: |
          ./gradlew jacocoTestCoverageVerification || true
          
          # ì»¤ë²„ë¦¬ì§€ ì¶”ì¶œ
          if [ -f build/reports/jacoco/test/html/index.html ]; then
            COVERAGE=$(grep -oP 'Total.*?([0-9]+)%' build/reports/jacoco/test/html/index.html | grep -oP '[0-9]+' | head -1 || echo "0")
          else
            COVERAGE="0"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "### ğŸ“Š Test Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          # ì»¤ë²„ë¦¬ì§€ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ê²½ê³ 
          if [ "$COVERAGE" -lt 70 ]; then
            echo "::warning::Test coverage is below 70% (${COVERAGE}%)"
          fi
        continue-on-error: true

      # ------------------------------------------------------
      # 8. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
      # ------------------------------------------------------
      - name: ğŸ“‹ Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            build/test-results/**/*.xml
          check_name: Test Results
          comment_mode: off

      # ------------------------------------------------------
      # 9. í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: ğŸ“¤ Upload test reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.event.pull_request.head.sha }}
          path: |
            build/reports/tests/test/
            build/reports/jacoco/test/html/
          retention-days: 7

      # ------------------------------------------------------
      # 10. JAR íŒŒì¼ ì €ì¥ (main PR/Push)
      # ------------------------------------------------------
      - name: ğŸ“¦ Upload build artifact (main)
        if: (github.base_ref == 'main' || github.ref_name == 'main') && success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-main-${{ github.event.pull_request.head.sha || github.sha }}
          path: build/libs/*.jar
          retention-days: 90

      # ------------------------------------------------------
      # 11. JAR íŒŒì¼ ì €ì¥ (dev PR/Push)
      # ------------------------------------------------------
      - name: ğŸ“¦ Upload build artifact (dev)
        if: (github.base_ref == 'dev' || github.ref_name == 'dev') && success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-dev-${{ github.event.pull_request.head.sha || github.sha }}
          path: build/libs/*.jar
          retention-days: 7

      # ------------------------------------------------------
      # 12. ë¹Œë“œ ì •ë³´ ì €ì¥ (CDì—ì„œ ì‚¬ìš©)
      # ------------------------------------------------------
      - name: ğŸ’¾ Save build metadata
        if: success()
        run: |
          mkdir -p build-info
          cat > build-info/metadata.json <<EOF
          {
            "buildTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "commitSha": "${{ github.event.pull_request.head.sha || github.sha }}",
            "commitShort": "$(echo ${{ github.event.pull_request.head.sha || github.sha }} | cut -c1-7)",
            "branch": "${{ github.head_ref || github.ref_name }}",
            "baseBranch": "${{ github.base_ref || github.ref_name }}",
            "prNumber": "${{ github.event.pull_request.number || 'N/A' }}",
            "prTitle": "${{ github.event.pull_request.title || 'Direct Push' }}",
            "author": "${{ github.event.pull_request.user.login || github.actor }}",
            "coverage": "${{ steps.coverage.outputs.coverage }}"
          }
          EOF
          cat build-info/metadata.json

      - name: ğŸ“¤ Upload build metadata
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata-${{ github.event.pull_request.head.sha || github.sha }}
          path: build-info/metadata.json
          retention-days: 30

      # ------------------------------------------------------
      # 13. PRì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„±
      # ------------------------------------------------------
      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || 'N/A';
            const checkstyle = '${{ steps.checkstyle.outcome }}';
            const build = '${{ steps.build.outcome }}';
            const test = '${{ steps.test.outcome }}';
            
            const getIcon = (status) => status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
            
            const getCoverageColor = (cov) => {
              const num = parseInt(cov);
              if (num >= 80) return 'ğŸŸ¢';
              if (num >= 70) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };
            
            const body = `## ğŸ” Backend CI Results
            
            | Check | Status | Details |
            |-------|--------|---------|
            | ğŸ” Code Style | ${getIcon(checkstyle)} ${checkstyle} | Checkstyle ê²€ì‚¬ |
            | ğŸ—ï¸ Build | ${getIcon(build)} ${build} | Gradle ë¹Œë“œ |
            | ğŸ§ª Tests | ${getIcon(test)} ${test} | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ |
            | ğŸ“Š Coverage | ${getCoverageColor(coverage)} ${coverage}% | í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ |
            
            <details>
            <summary>ğŸ“‹ ìƒì„¸ ì •ë³´</summary>
            
            - **ë¸Œëœì¹˜:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`
            - **ì»¤ë°‹:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            - **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            
            ### ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€
            - ğŸŸ¢ 80% ì´ìƒ: ìš°ìˆ˜
            - ğŸŸ¡ 70-79%: ì–‘í˜¸
            - ğŸ”´ 70% ë¯¸ë§Œ: ê°œì„  í•„ìš”
            
            [ğŸ“Š ì „ì²´ ë¦¬í¬íŠ¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            </details>
            
            ${coverage < 70 ? '\nâš ï¸ **ì£¼ì˜:** í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ê¸°ì¤€(70%)ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤.' : ''}
            ${test === 'failure' ? '\nâŒ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:** ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' : ''}
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Backend CI Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ------------------------------------------------------
      # 14. Discord ì•Œë¦¼ - ì„±ê³µ (PR only)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success() && github.event_name == 'pull_request'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CI Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… Backend CI ì„±ê³µ"
          embed-description: |
            **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜:** `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
            **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            **ì»¤ë²„ë¦¬ì§€:** ${{ steps.coverage.outputs.coverage }}%
            
            ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰
            
            [ğŸ”— PR ë³´ê¸°](${{ github.event.pull_request.html_url }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.pull_request.updated_at }}

      # ------------------------------------------------------
      # 15. Discord ì•Œë¦¼ - ì‹¤íŒ¨ (PR only)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure() && github.event_name == 'pull_request'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CI Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ Backend CI ì‹¤íŒ¨"
          embed-description: |
            **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜:** `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
            **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            
            **ì‹¤íŒ¨ ë‹¨ê³„:**
            â€¢ Code Style: ${{ steps.checkstyle.outcome }}
            â€¢ Build: ${{ steps.build.outcome }}
            â€¢ Tests: ${{ steps.test.outcome }}
            
            [ğŸ”— PR ë³´ê¸°](${{ github.event.pull_request.html_url }})
            [ğŸ“‹ CI ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.pull_request.updated_at }}