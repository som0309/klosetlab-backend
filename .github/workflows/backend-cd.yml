name: Backend CD

# ============================================================
# íŠ¸ë¦¬ê±° ì„¤ì •: CI ì›Œí¬í”Œë¡œìš° ì™„ë£Œ í›„ ìë™ ì‹¤í–‰
# ============================================================
on:
  workflow_run:
    workflows: ["Backend CI"]
    types:
      - completed
    branches:
      - dev
      - main

permissions:
  contents: read
  actions: read

# ============================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ============================================================
env:
  APP_DIR: /home/ubuntu/app/backend
  BACKUP_DIR: /home/ubuntu/backups/backend

# ============================================================
# Dev í™˜ê²½ ë°°í¬
# ============================================================
jobs:
  deploy-dev:
    name: Deploy to Development
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev' &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest
    environment:
      name: development
    timeout-minutes: 15

    steps:
      # ------------------------------------------------------
      # 1. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download build metadata
        uses: actions/download-artifact@v4
        with:
          name: build-metadata-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: ğŸ“‹ Display build metadata
        run: |
          if [ -f metadata.json ]; then
            echo "### ğŸ“Š Build Metadata" >> $GITHUB_STEP_SUMMARY
            cat metadata.json | jq '.' >> $GITHUB_STEP_SUMMARY
            cat metadata.json
          else
            echo "âš ï¸ Build metadata not found"
          fi

      # ------------------------------------------------------
      # 2. JAR ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-dev-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "### ğŸ“¦ Downloaded Files" >> $GITHUB_STEP_SUMMARY
          ls -lh *.jar >> $GITHUB_STEP_SUMMARY
          
          # JAR íŒŒì¼ ê²€ì¦
          JAR_FILE=$(ls *.jar | head -1)
          JAR_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE")
          echo "JAR File: $JAR_FILE"
          echo "JAR Size: $JAR_SIZE bytes"
          
          # ìµœì†Œ í¬ê¸° ê²€ì¦ (1MB)
          if [ "$JAR_SIZE" -lt 1048576 ]; then
            echo "::error::JAR file is too small (< 1MB). Build may have failed."
            exit 1
          fi
          
          echo "âœ… JAR file verification passed"

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status before deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ“Š Disk Usage:"
            df -h ${{ env.APP_DIR }}
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 90 ]; then
              echo "::warning::Disk usage is high: ${DISK_USAGE}%"
            fi
            
            # ë©”ëª¨ë¦¬ í™•ì¸
            echo "ğŸ’¾ Memory Usage:"
            free -h
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ğŸ”„ Current Process:"
            if pgrep -f "app.jar" > /dev/null; then
              echo "âœ… Application is currently running"
              PID=$(pgrep -f "app.jar")
              echo "Current PID: $PID"
            else
              echo "âš ï¸ Application is not running"
            fi
            
            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p ${{ env.BACKUP_DIR }}
            mkdir -p /tmp/backend-deploy
            
            echo "âœ… Server check completed"

      # ------------------------------------------------------
      # 4. JAR íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer JAR to Dev Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          source: "*.jar"
          target: "/tmp/backend-deploy"
          overwrite: true

      # ------------------------------------------------------
      # 5. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Run deployment script
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          command-timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}
            
            # JAR íŒŒì¼ ì´ë™ (sudo ì œê±°)
            echo "Moving JAR file..."
            sudo mv /tmp/backend-deploy/*.jar ./app-new.jar
            
            # ì†Œìœ ì ë³€ê²½ (í˜„ì¬ ì‚¬ìš©ìë¡œ)
            sudo chown $USER:$USER ./app-new.jar
            
            # deploy.sh ì‹¤í–‰ ê¶Œí•œ í™•ì¸
            if [ ! -x "./deploy.sh" ]; then
              echo "Making deploy.sh executable..."
              chmod +x ./deploy.sh
            fi
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "./deploy.sh" ]; then
              echo "Executing deploy.sh..."
              bash ./deploy.sh
            else
              echo "ERROR: deploy.sh not found!"
              exit 1
            fi

      # ------------------------------------------------------
      # 6. ë°°í¬ í›„ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Post-deployment verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Post-Deployment Verification ==="
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if pgrep -f "app.jar" > /dev/null; then
              PID=$(pgrep -f "app.jar")
              PID_COUNT=$(pgrep -f "app.jar" | wc -l)
              echo "âœ… Application is running (PID: $PID)"
            
              if [ $PID_COUNT -gt 1 ]; then
                echo "âš ï¸ WARNING: Multiple processes found ($PID_COUNT)"
              fi
            else
              echo "âŒ Application is not running!"
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "Checking application health..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
                curl -s http://localhost:8080/actuator/health | jq '.' || true
                exit 0
              fi
            
              echo "Waiting for application to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
            
            echo "âŒ Application health check failed after $MAX_RETRIES attempts!"
            
            # ë¡œê·¸ ì¶œë ¥
            if [ -f "${{ env.APP_DIR }}/logs/application.log" ]; then
              echo "=== Last 100 lines of log ==="
              tail -100 ${{ env.APP_DIR }}/logs/application.log
            fi
            
            exit 1
      # ------------------------------------------------------
      # 7. ë°°í¬ ì •ë³´ ê¸°ë¡
      # ------------------------------------------------------
      - name: ğŸ“ Record deployment info
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            
            cat > deployment-info.json <<EOF
            {
              "environment": "development",
              "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "commit_sha": "${{ github.event.workflow_run.head_sha }}",
              "branch": "${{ github.event.workflow_run.head_branch }}",
              "deployer": "${{ github.event.workflow_run.head_commit.author.name }}",
              "workflow_run_id": "${{ github.run_id }}"
            }
            EOF
            
            echo "âœ… Deployment info recorded"
            cat deployment-info.json

      # ------------------------------------------------------
      # 8. Discord ì•Œë¦¼ - ì„±ê³µ
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… Backend Dev ë°°í¬ ì„±ê³µ"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

      # ------------------------------------------------------
      # 9. Discord ì•Œë¦¼ - ì‹¤íŒ¨
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ Backend Dev ë°°í¬ ì‹¤íŒ¨"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

  # ============================================================
  # Production í™˜ê²½ ë°°í¬
  # ============================================================
  deploy-prod:
    name: Deploy to Production
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
    timeout-minutes: 20

    steps:
      # ------------------------------------------------------
      # 0. Debug: ë¸Œëœì¹˜ ì •ë³´ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Debug branch information
        run: |
          echo "=== Workflow Run Information ==="
          echo "Head Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Event: ${{ github.event.workflow_run.event }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "=== Current Context ==="
          echo "Ref: ${{ github.ref }}"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"

      # ------------------------------------------------------
      # 1. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download build metadata
        uses: actions/download-artifact@v4
        with:
          name: build-metadata-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: ğŸ“‹ Display and validate build metadata
        run: |
          if [ -f metadata.json ]; then
            echo "### ğŸ“Š Build Metadata" >> $GITHUB_STEP_SUMMARY
            cat metadata.json | jq '.' >> $GITHUB_STEP_SUMMARY
          
            # ì»¤ë²„ë¦¬ì§€ ê²€ì¦
            COVERAGE=$(cat metadata.json | jq -r '.coverage // "0"')
            echo "Test Coverage: ${COVERAGE}%"
          
            if [ "$COVERAGE" -lt 70 ]; then
              echo "::warning::Test coverage (${COVERAGE}%) is below 70%. Proceed with caution."
            fi
          else
            echo "âš ï¸ Build metadata not found"
          fi

      # ------------------------------------------------------
      # 2. JAR ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-main-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "### ğŸ“¦ Downloaded Files" >> $GITHUB_STEP_SUMMARY
          ls -lh *.jar >> $GITHUB_STEP_SUMMARY
          
          # JAR íŒŒì¼ ê²€ì¦
          JAR_FILE=$(ls *.jar | head -1)
          JAR_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE")
          echo "JAR File: $JAR_FILE"
          echo "JAR Size: $JAR_SIZE bytes"
          
          # ìµœì†Œ í¬ê¸° ê²€ì¦ (1MB)
          if [ "$JAR_SIZE" -lt 1048576 ]; then
            echo "::error::JAR file is too small (< 1MB). Build may have failed."
            exit 1
          fi
          
          # SHA256 ì²´í¬ì„¬ ê³„ì‚°
          JAR_SHA256=$(sha256sum "$JAR_FILE" | cut -d' ' -f1)
          echo "JAR SHA256: $JAR_SHA256"
          
          echo "âœ… JAR file verification passed"

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status before deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ“Š Disk Usage:"
            df -h ${{ env.APP_DIR }}
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 85 ]; then
              echo "ERROR: Disk usage is critically high: ${DISK_USAGE}%"
              exit 1
            fi
            
            # ë©”ëª¨ë¦¬ í™•ì¸
            echo "ğŸ’¾ Memory Usage:"
            free -h
            
            # í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸
            echo "ğŸ”„ Current Application Status:"
            if pgrep -f "app.jar" > /dev/null; then
              PID=$(pgrep -f "app.jar")
              echo "âœ… Application is running (PID: $PID)"
            
              # í—¬ìŠ¤ì²´í¬
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
              else
                echo "âš ï¸ Application is running but unhealthy"
              fi
            else
              echo "âš ï¸ Application is not running"
            fi
            
            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p ${{ env.BACKUP_DIR }}
            mkdir -p /tmp/backend-deploy
            
            echo "âœ… Production server check completed"

      # ------------------------------------------------------
      # 4. í˜„ì¬ ë²„ì „ ë°±ì—…
      # ------------------------------------------------------
      - name: ğŸ’¾ Backup current version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # í˜„ì¬ JAR íŒŒì¼ ë°±ì—…
            if [ -f "app.jar" ]; then
              cp app.jar ${{ env.BACKUP_DIR }}/app_prod_$TIMESTAMP.jar
              echo "âœ… Production backup created: app_prod_$TIMESTAMP.jar"
            
              # ë°±ì—… íŒŒì¼ ì •ë³´
              BACKUP_SIZE=$(stat -c%s ${{ env.BACKUP_DIR }}/app_prod_$TIMESTAMP.jar)
              BACKUP_SHA256=$(sha256sum ${{ env.BACKUP_DIR }}/app_prod_$TIMESTAMP.jar | cut -d' ' -f1)
              echo "Backup size: $BACKUP_SIZE bytes"
              echo "Backup SHA256: $BACKUP_SHA256"
            
              # ë°°í¬ ì •ë³´ë„ ë°±ì—…
              if [ -f "deployment-info.json" ]; then
                cp deployment-info.json ${{ env.BACKUP_DIR }}/deployment-info_$TIMESTAMP.json
                echo "âœ… Deployment info backed up"
              fi
            else
              echo "âš ï¸ No existing JAR to backup (first deployment)"
            fi
            
            # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (ìµœê·¼ 10ê°œë§Œ ìœ ì§€)
            cd ${{ env.BACKUP_DIR }}
            ls -t app_prod_*.jar 2>/dev/null | tail -n +11 | xargs -r rm -v
            ls -t deployment-info_*.json 2>/dev/null | tail -n +11 | xargs -r rm -v
            
            echo "ğŸ“¦ Current backups:"
            ls -lh app_prod_*.jar 2>/dev/null || echo "No backups found"
      # ------------------------------------------------------
      # 5. JAR íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer JAR to Production Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          source: "*.jar"
          target: "/tmp/backend-deploy"
          overwrite: true


      # ------------------------------------------------------
      # 6. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Run deployment script
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          command-timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}
            
            # JAR íŒŒì¼ ì´ë™
            echo "Moving JAR file..."
            mv /tmp/backend-deploy/*.jar ./app-new.jar
            
            # JAR íŒŒì¼ ê²€ì¦
            JAR_SIZE=$(stat -c%s app-new.jar)
            JAR_SHA256=$(sha256sum app-new.jar | cut -d' ' -f1)
            echo "New JAR size: $JAR_SIZE bytes"
            echo "New JAR SHA256: $JAR_SHA256"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "./deploy.sh" ]; then
              echo "Executing deploy.sh..."
              chmod +x ./deploy.sh
              bash ./deploy.sh
            else
              echo "ERROR: deploy.sh not found!"
              exit 1
            fi

      # ------------------------------------------------------
      # 7. ë°°í¬ í›„ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Post-deployment verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Post-Deployment Verification ==="
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if pgrep -f "app.jar" > /dev/null; then
              PID=$(pgrep -f "app.jar")
              echo "âœ… Application is running (PID: $PID)"
            else
              echo "âŒ Application is not running!"
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "Checking application health..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
            
                # ìƒì„¸ ì •ë³´ ì¶œë ¥
                echo "=== Health Details ==="
                curl -s http://localhost:8080/actuator/health | jq '.' || true
            
                echo "=== Application Info ==="
                curl -s http://localhost:8080/actuator/info | jq '.' || true
            
                exit 0
              fi
            
              echo "Waiting for application to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
            
            echo "âŒ Application health check failed after $MAX_RETRIES attempts!"
            
            # ë¡œê·¸ ì¶œë ¥
            if [ -f "${{ env.APP_DIR }}/logs/application.log" ]; then
              echo "=== Last 100 lines of log ==="
              tail -100 ${{ env.APP_DIR }}/logs/application.log
            fi
            
            exit 1

      # ------------------------------------------------------
      # 8. Smoke Test
      # ------------------------------------------------------
      - name: ğŸ§ª Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Smoke Tests ==="
            
            FAILED=0
            
            # Test 1: Health
            echo "1. Testing health endpoint..."
            if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
              echo "âœ… Health check passed"
            else
              echo "âŒ Health check failed"
              FAILED=$((FAILED + 1))
            fi
            
            # Test 2: Info
            echo "2. Testing info endpoint..."
            if curl -f -s http://localhost:8080/actuator/info > /dev/null; then
              echo "âœ… Info endpoint passed"
            else
              echo "âŒ Info endpoint failed"
              FAILED=$((FAILED + 1))
            fi
            
            # Test 3: Metrics
            echo "3. Testing metrics endpoint..."
            if curl -f -s http://localhost:8080/actuator/metrics > /dev/null; then
              echo "âœ… Metrics endpoint passed"
            else
              echo "âŒ Metrics endpoint failed"
              FAILED=$((FAILED + 1))
            fi
            
            # Test 4: Database connectivity
            echo "4. Testing database connectivity..."
            DB_STATUS=$(curl -s http://localhost:8080/actuator/health | jq -r '.components.db.status // "UNKNOWN"')
            if [ "$DB_STATUS" = "UP" ]; then
              echo "âœ… Database connectivity passed"
            else
              echo "âš ï¸ Database status: $DB_STATUS"
            fi
            
            # Test 5: Redis connectivity
            echo "5. Testing Redis connectivity..."
            REDIS_STATUS=$(curl -s http://localhost:8080/actuator/health | jq -r '.components.redis.status // "UNKNOWN"')
            if [ "$REDIS_STATUS" = "UP" ]; then
              echo "âœ… Redis connectivity passed"
            else
              echo "âš ï¸ Redis status: $REDIS_STATUS"
            fi
            
            if [ $FAILED -gt 0 ]; then
              echo "âŒ $FAILED smoke test(s) failed"
              exit 1
            fi
            
            echo "âœ… All smoke tests passed"

      # ------------------------------------------------------
      # 9. ë°°í¬ ì •ë³´ ê¸°ë¡
      # ------------------------------------------------------
      - name: ğŸ“ Record deployment info
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            JAR_SHA256=$(sha256sum app.jar | cut -d' ' -f1)
            
            cat > deployment-info.json <<EOF
            {
              "environment": "production",
              "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "commit_sha": "${{ github.event.workflow_run.head_sha }}",
              "branch": "${{ github.event.workflow_run.head_branch }}",
              "deployer": "${{ github.event.workflow_run.head_commit.author.name }}",
              "workflow_run_id": "${{ github.run_id }}",
              "jar_sha256": "$JAR_SHA256"
            }
            EOF
            
            echo "âœ… Deployment info recorded"
            cat deployment-info.json

      # ------------------------------------------------------
      # 10. ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ (ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: âš ï¸ Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            
            echo "=== Rolling back to previous version ==="
            
            if [ -f "./rollback.sh" ]; then
              chmod +x ./rollback.sh
              bash ./rollback.sh
            
              # ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
              sleep 5
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "âœ… Rollback successful, application is healthy"
              else
                echo "âŒ Rollback completed but application is unhealthy!"
                echo "Manual intervention required!"
              fi
            else
              echo "âŒ rollback.sh not found!"
              echo "Manual rollback required!"
            fi

      # ------------------------------------------------------
      # 11. Discord ì•Œë¦¼ - ì„±ê³µ
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… Backend Production ë°°í¬ ì„±ê³µ"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            [ğŸŒ Production ì„œë¹„ìŠ¤](https://your-domain.com)
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

      # ------------------------------------------------------
      # 12. Discord ì•Œë¦¼ - ì‹¤íŒ¨
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ Backend Production ë°°í¬ ì‹¤íŒ¨ (ë¡¤ë°± ì™„ë£Œ)"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            âš ï¸ ë°°í¬ ì‹¤íŒ¨ë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            [ğŸŒ Production ì„œë¹„ìŠ¤](https://your-domain.com)
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

      # ------------------------------------------------------
      # 13. Slack ì•Œë¦¼ - ì„±ê³µ (Production ì „ìš© - ì„ íƒì‚¬í•­)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Slack notification on success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "âœ… Production ë°°í¬ ì„±ê³µ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… Backend Production ë°°í¬ ì„±ê³µ"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\nProduction ğŸ”´"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n`${{ github.event.workflow_run.head_branch }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.event.workflow_run.head_sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“‹ CI/CD ë¡œê·¸"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸŒ ì„œë¹„ìŠ¤ í™•ì¸"
                      },
                      "url": "https://your-domain.com"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      # ------------------------------------------------------
      # 14. Slack ì•Œë¦¼ - ì‹¤íŒ¨ (Production ì „ìš© - ì„ íƒì‚¬í•­)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "âŒ Production ë°°í¬ ì‹¤íŒ¨",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ Backend Production ë°°í¬ ì‹¤íŒ¨"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\nProduction ğŸ”´"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n`${{ github.event.workflow_run.head_branch }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.event.workflow_run.head_sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸ“‹ CI/CD ë¡œê·¸"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸŒ ì„œë¹„ìŠ¤ í™•ì¸"
                      },
                      "url": "https://your-domain.com"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true