name: Backend CI

# ============================================================
# íŠ¸ë¦¬ê±° ì„¤ì •: PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ + ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
# ============================================================
on:
  # PR ì´ë²¤íŠ¸ (ì½”ë“œ ê²€ì¦ìš©)
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev
      - main
    # ë°±ì—”ë“œ ê´€ë ¨ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'
      - 'Dockerfile'
      - '.github/workflows/backend-ci.yml'

  # Push ì´ë²¤íŠ¸ (Docker ë¹Œë“œ ë° ECR í‘¸ì‹œ)
  push:
    branches:
      - dev
      - main
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'
      - 'Dockerfile'
      - '.github/workflows/backend-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write  # OIDCë¥¼ ìœ„í•œ ê¶Œí•œ ì¶”ê°€

# ============================================================
# ë™ì‹œì„± ì œì–´: ê°™ì€ PR ë˜ëŠ” ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì‹¤í–‰ ì‹œ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
# ============================================================
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ============================================================
# Jobs
# ============================================================
jobs:
  # ========================================================
  # Job 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # ========================================================
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # MySQL ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ (í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë² ì´ìŠ¤)
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.DB_NAME }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s

    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    env:
      SPRING_PROFILES_ACTIVE: ci
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: root
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}

    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
      version: ${{ steps.version.outputs.version }}
      image_tag: ${{ steps.version.outputs.image_tag }}
      commit_sha: ${{ steps.version.outputs.commit_sha }}

    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ë²„ì „ íƒœê·¸ í™•ì¸ìš©)

      # ------------------------------------------------------
      # 2. ë²„ì „ ì •ë³´ ì¶”ì¶œ
      # ------------------------------------------------------
      - name: Extract version info
        id: version
        run: |
          # Git íƒœê·¸ì—ì„œ ìµœì‹  ì‹œë§¨í‹± ë²„ì „ ê°€ì ¸ì˜¤ê¸°
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${LATEST_TAG#v}  # v ì œê±°
          
          # ì»¤ë°‹ SHA (short)
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          # ë¸Œëœì¹˜ëª…
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±: {branch}-{version}-{sha}
          # ì˜ˆ: dev-1.0.0-abc1234, main-1.0.0-abc1234
          IMAGE_TAG="${BRANCH}-${VERSION}-${COMMIT_SHA}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          
          echo "### Version Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${COMMIT_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${BRANCH}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------
      # 3. JDK ì„¤ì • ë° Gradle ìºì‹±
      # ------------------------------------------------------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # ------------------------------------------------------
      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      # ------------------------------------------------------
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ------------------------------------------------------
      # 5. ì •ì  ë¶„ì„ - Checkstyle (PRë§Œ)
      # ------------------------------------------------------
      - name: Run Checkstyle
        if: github.event_name == 'pull_request'
        id: checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: false

      # ------------------------------------------------------
      # 6. ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸, í•­ìƒ ì‹¤í–‰)
      # ------------------------------------------------------
      - name: Build with Gradle
        id: build
        run: ./gradlew clean build -x test

      # ------------------------------------------------------
      # 7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì • (PRë§Œ)
      # ------------------------------------------------------
      - name: Run tests with coverage
        if: github.event_name == 'pull_request'
        id: test
        run: ./gradlew test jacocoTestReport --parallel

      # ------------------------------------------------------
      # 8. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê²€ì¦ (PRë§Œ)
      # ------------------------------------------------------
      - name: Verify test coverage
        if: github.event_name == 'pull_request'
        id: coverage
        run: |
          ./gradlew jacocoTestCoverageVerification || true
          
          # ì»¤ë²„ë¦¬ì§€ ì¶”ì¶œ
          if [ -f build/reports/jacoco/test/html/index.html ]; then
            COVERAGE=$(grep -oP 'Total.*?([0-9]+)%' build/reports/jacoco/test/html/index.html | grep -oP '[0-9]+' | head -1 || echo "0")
          else
            COVERAGE="0"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "### Test Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          # ì»¤ë²„ë¦¬ì§€ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ê²½ê³ 
          if [ "$COVERAGE" -lt 70 ]; then
            echo "::warning::Test coverage is below 70% (${COVERAGE}%)"
          fi
        continue-on-error: true

      # ------------------------------------------------------
      # 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ (PRë§Œ)
      # ------------------------------------------------------
      - name: Publish test results
        if: github.event_name == 'pull_request' && always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            build/test-results/**/*.xml
          check_name: Test Results
          comment_mode: off

      # ------------------------------------------------------
      # 10. í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (PR ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: Upload test reports
        if: github.event_name == 'pull_request' && failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ steps.version.outputs.commit_sha }}
          path: |
            build/reports/tests/test/
            build/reports/jacoco/test/html/
          retention-days: 7

      # ------------------------------------------------------
      # 11. JAR íŒŒì¼ ì €ì¥ (í•­ìƒ)
      # ------------------------------------------------------
      - name: Upload JAR artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-jar-${{ steps.version.outputs.commit_sha }}
          path: build/libs/*.jar
          retention-days: 7

      # ------------------------------------------------------
      # 12. PRì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„± (PRë§Œ)
      # ------------------------------------------------------
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || 'N/A';
            const checkstyle = '${{ steps.checkstyle.outcome }}';
            const build = '${{ steps.build.outcome }}';
            const test = '${{ steps.test.outcome }}';
            const version = '${{ steps.version.outputs.version }}';
            const imageTag = '${{ steps.version.outputs.image_tag }}';
            
            const getIcon = (status) => status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
            
            const getCoverageColor = (cov) => {
              const num = parseInt(cov);
              if (num >= 80) return 'ğŸŸ¢';
              if (num >= 70) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };
            
            const body = `## ğŸ” Backend CI Results
            
            | Check | Status | Details |
            |-------|--------|---------|
            | ğŸ” Code Style | ${getIcon(checkstyle)} ${checkstyle} | Checkstyle ê²€ì‚¬ |
            | ğŸ—ï¸ Build | ${getIcon(build)} ${build} | Gradle ë¹Œë“œ |
            | ğŸ§ª Tests | ${getIcon(test)} ${test} | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ |
            | ğŸ“Š Coverage | ${getCoverageColor(coverage)} ${coverage}% | í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ |
            
            ### ğŸ“¦ Build Information
            - **Version:** \`${version}\`
            - **Image Tag:** \`${imageTag}\`
            - **Branch:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`
            - **Commit:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            - **Author:** @${{ github.event.pull_request.user.login }}
            
            <details>
            <summary>ğŸ“‹ ìƒì„¸ ì •ë³´</summary>
            
            ### ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€
            - ğŸŸ¢ 80% ì´ìƒ: ìš°ìˆ˜
            - ğŸŸ¡ 70-79%: ì–‘í˜¸
            - ğŸ”´ 70% ë¯¸ë§Œ: ê°œì„  í•„ìš”
            
            [ğŸ“Š ì „ì²´ ë¦¬í¬íŠ¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            </details>
            
            ${coverage < 70 ? '\nâš ï¸ **ì£¼ì˜:** í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ê¸°ì¤€(70%)ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤.' : ''}
            ${test === 'failure' ? '\nâŒ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:** ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' : ''}
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Backend CI Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ========================================================
  # Job 2: Docker ë¹Œë“œ ê²€ì¦ (PRë§Œ)
  # ========================================================
  docker-validate:
    name: Docker Build Validation
    needs: test-and-build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. ë¹Œë“œí•œ JAR ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar-${{ needs.build.outputs.commit_sha }}
          path: build/libs/

      # ------------------------------------------------------
      # 3. Dockerfile ë¬¸ë²• ê²€ì‚¬
      # ------------------------------------------------------
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      # ------------------------------------------------------
      # 4. Docker Buildx ì„¤ì •
      # ------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ------------------------------------------------------
      # 5. Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
      # ------------------------------------------------------
      - name: Build Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: test:${{ needs.build.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.build.outputs.version }}

      # ------------------------------------------------------
      # 6. ê²€ì¦ ê²°ê³¼ ìš”ì•½
      # ------------------------------------------------------
      - name: Docker validation success
        run: |
          echo "### âœ… Docker Build Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "Dockerfileì´ ì •ìƒì ìœ¼ë¡œ ë¹Œë“œë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`test:${{ needs.build.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------
      # 7. PR ì½”ë©˜íŠ¸
      # ------------------------------------------------------
      - name: Comment Docker validation result
        uses: actions/github-script@v7
        with:
          script: |
            const body = `### ğŸ³ Docker Build Validation
            
            âœ… Dockerfile ë¹Œë“œ ê²€ì¦ ì™„ë£Œ
            - **Image Tag:** \`test:${{ needs.build.outputs.image_tag }}\`
            - Hadolint ê²€ì‚¬ í†µê³¼
            - Docker ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µ
            
            ë¨¸ì§€ í›„ ECRì— í‘¸ì‹œë©ë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # ========================================================
  # Job 3: Docker ë¹Œë“œ ë° ECR í‘¸ì‹œ (Push ì´ë²¤íŠ¸ë§Œ)
  # ========================================================
  deploy:
    name: Deploy to ECR
    needs: test-and-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # OIDCë¥¼ ìœ„í•œ permissions ì„¤ì •
    permissions:
      id-token: write
      contents: read

    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # 2. JAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar-${{ needs.test-and-build.outputs.commit_sha }}
          path: build/libs/

      # ------------------------------------------------------
      # 3. AWS OIDC ì¸ì¦
      # ------------------------------------------------------
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-${{ github.run_id }}

      # ------------------------------------------------------
      # 4. ECR ë¡œê·¸ì¸
      # ------------------------------------------------------
      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      # ------------------------------------------------------
      # 5. Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      # ------------------------------------------------------
      - name: Extract Docker metadata
        id: meta
        run: |
          ECR_REGISTRY=${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG=${{ needs.test-and-build.outputs.image_tag }}
          BRANCH=${{ github.ref_name }}
          
          # ì „ì²´ ì´ë¯¸ì§€ URI
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          LATEST_TAG="${ECR_REGISTRY}/${ECR_REPOSITORY}:${BRANCH}-latest"
          
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${ECR_REGISTRY}" >> $GITHUB_OUTPUT
          echo "ecr_repository=${ECR_REPOSITORY}" >> $GITHUB_OUTPUT
          
          echo "### ğŸ³ Docker Image Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URI:** \`${IMAGE_URI}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Tag:** \`${LATEST_TAG}\`" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------
      # 6. Docker Buildx ì„¤ì •
      # ------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ------------------------------------------------------
      # 7. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ------------------------------------------------------
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_uri }}
            ${{ steps.meta.outputs.latest_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            VERSION=${{ needs.test-and-build.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      # ------------------------------------------------------
      # 8. ì´ë¯¸ì§€ ì·¨ì•½ì  ìŠ¤ìº” (Trivy)
      # ------------------------------------------------------
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.image_uri }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # ------------------------------------------------------
      # 9. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ì €ì¥
      # ------------------------------------------------------
      - name: Save build metadata
        run: |
          mkdir -p build-info
          cat > build-info/docker-metadata.json <<EOF
          {
            "imageUri": "${{ steps.meta.outputs.image_uri }}",
            "latestTag": "${{ steps.meta.outputs.latest_tag }}",
            "ecrRegistry": "${{ steps.meta.outputs.ecr_registry }}",
            "ecrRepository": "${{ steps.meta.outputs.ecr_repository }}",
            "imageTag": "${{ needs.test-and-build.outputs.image_tag }}",
            "version": "${{ needs.test-and-build.outputs.version }}",
            "branch": "${{ github.ref_name }}",
            "commitSha": "${{ github.sha }}",
            "buildTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "author": "${{ github.actor }}",
            "coverage": "${{ needs.test-and-build.outputs.coverage }}"
          }
          EOF
          cat build-info/docker-metadata.json

      # ------------------------------------------------------
      # 10. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ
      # ------------------------------------------------------
      - name: Upload build metadata
        uses: actions/upload-artifact@v4
        with:
          name: docker-metadata-${{ github.ref_name }}-${{ github.sha }}
          path: build-info/docker-metadata.json
          retention-days: 90

      # ------------------------------------------------------
      # 11. Discord ì•Œë¦¼ - ì„±ê³µ
      # ------------------------------------------------------
      - name: Send Discord notification on success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CI/CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… Docker ì´ë¯¸ì§€ ECR í‘¸ì‹œ ì„±ê³µ"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ë²„ì „:** `${{ needs.test-and-build.outputs.version }}`
            **ì´ë¯¸ì§€ íƒœê·¸:** `${{ needs.test-and-build.outputs.image_tag }}`
            
            **ECR URI:**
            ```
            ${{ steps.meta.outputs.image_uri }}
            ```
            
            CD íŒŒì´í”„ë¼ì¸ì—ì„œ ìœ„ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸš€
            
            [ğŸ”— Actions ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}

      # ------------------------------------------------------
      # 12. Discord ì•Œë¦¼ - ì‹¤íŒ¨
      # ------------------------------------------------------
      - name: Send Discord notification on failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "Backend CI/CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ Docker ì´ë¯¸ì§€ ECR í‘¸ì‹œ ì‹¤íŒ¨"
          embed-description: |
            **ë¸Œëœì¹˜:** `${{ github.ref_name }}`
            **ì»¤ë°‹:** `${{ github.sha }}`
            
            Docker ë¹Œë“œ ë˜ëŠ” ECR í‘¸ì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            
            [ğŸ”— Actions ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}